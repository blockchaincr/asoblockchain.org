jQuery(document).ready(function($){
    $(document.body).removeClass('no-js').addClass('js');

    initPolyfills();

    // Utilities
    initClassToggle();

    initAnchorScroll();


    initSubscribe__popup();

    initSignup__popup();

    initNav();

    initAccordion();

    initStickyHeader();

    initTestimonials();

    initInViewSections();
});

function isMobile() {
    return window.matchMedia('(max-width:767px)').matches;
}

function initPolyfills() {
    // CSS object-fit for IE
    objectFitImages();

    // polyfill for IE - startsWith
    if (!String.prototype.startsWith) {
        String.prototype.startsWith = function(searchString, position) {
            position = position || 0;
            return this.indexOf(searchString, position) === position;
        };
    }
}

function initClassToggle() {
    // Toggle class on click
    $(document.body).on('click', '[data-toggle="class"][data-class]', function(event) {
        var $trigger = $(this);
        var $target = $($trigger.data('target') ? $trigger.data('target') : $trigger.attr('href'));

        if($target.length) {
            event.preventDefault();
            $target.toggleClass($trigger.data('class'));
            $trigger.toggleClass('classed');
        }
    });
}

function initAnchorScroll() {
    // Smooth anchor scrolling
    $('a[href*="#"]:not([data-toggle])').click(function(event) {

        if(this.hash == '#signup'){
            event.preventDefault();
        }else{
            if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'') && location.hostname == this.hostname) {
                var target = $(this.hash);
                target = target.length ? target : $('[name="'+this.hash.slice(1)+'"]');
                if (target.length) {
                    event.preventDefault();
                   
                    $('html, body').animate({
                        scrollTop: target.offset().top - $('.header').outerHeight()
                    }, 1000);
                }
            }
        }
    });
}


function initSubscribe__popup(){

    $('.subscribe__popup__hamburger').click(function(){
        $('html').removeClass('subscribeactive overflow--hidden');
    });

    $('[href="#subscribepopup"]').click(function(){
        event.preventDefault();
        $('html').addClass('subscribeactive overflow--hidden');
        
    });
}
function initSignup__popup(){
    var subscribeEl = $('#subscribe'); // adds to the bottom value
    var footerEl = $('.footer'); // adds to the bottom value
    var memberEl = $('#member'); // div that sets the height for html structure
    var memberInnerEl = $('.signup__inner'); // div that gets position attributes
    var popupInnerEl = $('.signup__popup'); // popup div that is set for overflow purposes

    var signupHeight = 0; // height of inner signup content
    var footerHeight = 0; // height of combined subscribe + footer

    // sets the height and bottom position of the signup div, so it can be absolute and expand to fullscreen smoothly
    function setSignupPosition(){
        signupHeight = 0;
        footerHeight = 0;

        // disable transitions while calculating
        memberInnerEl.addClass('notransition');

        // reset heights
        memberEl.css('height','');
        memberInnerEl.css('bottom','');
        memberInnerEl.css('height','');
        $('.container', popupInnerEl).css('min-height','');

        recalcVariables();

        memberInnerEl.css('bottom', footerHeight);
        memberInnerEl.css('height', memberInnerEl.outerHeight(true));
        memberEl.css('height', memberInnerEl.outerHeight(true));
        $('.container', popupInnerEl).css('min-height', $('.container', popupInnerEl).outerHeight(true));

        // re-enable transition
        memberInnerEl.removeClass('notransition');
    }

    function recalcVariables(){
        footerHeight = subscribeEl.outerHeight(true) + footerEl.outerHeight(true);
        signupHeight = memberInnerEl.outerHeight(true);
    }

    setTimeout(function(){
        setSignupPosition();
    }, 300);

    var resizeTimer;
    $(window).on('resize', function(e) {
        clearTimeout(resizeTimer);

        // on stop resizing
        resizeTimer = setTimeout(function() {
        
            // if its open, just close it
            if(!$('html.signupactive').length){
                setSignupPosition();
            }else{
                $('html').removeClass('signupactive overflow--hidden');
                memberInnerEl.css('bottom', footerHeight);
                memberInnerEl.css('height', signupHeight);

                setSignupPosition();
            }

        }, 250);
    });

    $('.signup__popup__hamburger').click(function(){
        $('html').removeClass('signupactive overflow--hidden');
        memberInnerEl.css('bottom', footerHeight);
        memberInnerEl.css('height', signupHeight);
    });

    $('[href="#signup"]').click(function(){
        // scroll to bottom then do css animations
        if($(window).scrollTop() !== $(document).height() - $(window).height()){
            $('html,body').animate({scrollTop:$(document).height() - $(window).height()}, function(){
                $('html').addClass('signupactive overflow--hidden');
                memberInnerEl.css('bottom', '0px');
                memberInnerEl.css('height', $(window).height());
            });
        }else{
            $('html').addClass('signupactive overflow--hidden');
            memberInnerEl.css('bottom', '0px');
            memberInnerEl.css('height', $(window).height());
        }
        
    });
}


function initNav(){
    var hamburgers = '.hamburger, .nav__hamburger, .hero__hamburger, .header__hamburger';

    $(hamburgers).click(function(){
        if($(this).hasClass('open')){
            $(hamburgers).removeClass('open');
            $('.nav').removeClass('nav--open');
            $('html').removeClass('overflow--hidden');
        }else{
            $(hamburgers).addClass('open');
            $('.nav').addClass('nav--open');
            $('html').addClass('overflow--hidden');
        }
    });


    $('div.nav ul li a').click(function(){
        $(hamburgers).removeClass('open');
        $('.nav').removeClass('nav--open');
        $('html').removeClass('overflow--hidden');
    });
}

function initAccordion(){

    $(".copy-accordion__right__accordion:nth-child(2) .copy-accordion__right__accordion__button").toggleClass("active");
    $(".copy-accordion__right__accordion:nth-child(2) .copy-accordion__right__accordion__panel").css("maxHeight","105px");
        
        
    $(document).on("click",".copy-accordion__right__accordion__button",function(event){
        $(".copy-accordion__right__accordion__button").removeClass("active");

        $(".copy-accordion__right__accordion__panel").each(function(){
           this.style.maxHeight = null;
          
        });

        
        $(this).toggleClass("active");
        var panel = this.nextElementSibling;
        if (panel.style.maxHeight){
            panel.style.maxHeight = null;
        } else {
          panel.style.maxHeight = panel.scrollHeight + "px";
        } 
      });
}


function initStickyHeader(){
    var scrollTop = $(window).scrollTop();

    var headerEl = $('header');
    
    $(window).scroll(function(){
        scrollTop = $(window).scrollTop();

        if(scrollTop >= 100){
            headerEl.addClass('in');
            $('header .header__hamburger').show();
        }else{
            headerEl.removeClass('in');
            $('header .header__hamburger').hide();
        }
    });
}


function initTestimonials(){

    $('.under-hero__copyslider').on('init', function(event, slick){ 
        $('html').addClass('jsready');
    });
    
    $('.under-hero__imgslider').slick({
        slidesToShow: 1,
        speed: 1000,
        autoplay: true,
        autoplaySpeed: 5000,
        arrows:false,
        dots:false,
        infinite: true,
        vertical: true,
        asNavFor:'.under-hero__copyslider'
    });
    $('.under-hero__copyslider').slick({
        slidesToShow: 1,
        speed: 1000,
        autoplay: true,
        autoplaySpeed: 5000,
        arrows:false,
        dots:false,
        infinite: true,
        asNavFor:'.under-hero__imgslider'
    });
}


function initInViewSections(){
    var scrollTop = $(window).scrollTop();
    var windowHeight = $(window).height();
    var sections = $('section');

    $(window).scroll();

    $(window).scroll(function(){
        scrollTop = $(window).scrollTop();
        windowHeight = $(window).height();

        sections.each(function(){
            if($(this).offset().top < scrollTop + (windowHeight * .75)){
                $(this).addClass('inview');
            }


            // if completely out of view remove class
            if($(this).offset().top >= scrollTop + (windowHeight)){
                $(this).removeClass('inview');
            }
        });
    });
}



